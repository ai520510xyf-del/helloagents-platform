# ===================================================================
# Alertmanager é…ç½®æ–‡ä»¶
# HelloAgents Platform å‘Šè­¦è·¯ç”±å’Œé€šçŸ¥é…ç½®
# ===================================================================

global:
  resolve_timeout: 5m

  # Slack é…ç½® (éœ€è¦é…ç½® Webhook URL)
  # slack_api_url: 'https://hooks.slack.com/services/YOUR/WEBHOOK/URL'

# å‘Šè­¦æ¨¡æ¿
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# å‘Šè­¦è·¯ç”±é…ç½®
route:
  # é»˜è®¤æ¥æ”¶å™¨
  receiver: 'default'

  # åˆ†ç»„é…ç½®
  group_by: ['alertname', 'severity', 'component']
  group_wait: 10s        # ç­‰å¾… 10 ç§’æ”¶é›†åŒç»„å‘Šè­¦
  group_interval: 10s    # æ¯ 10 ç§’è¯„ä¼°ä¸€æ¬¡åˆ†ç»„
  repeat_interval: 12h   # 12 å°æ—¶åé‡å¤å‘é€æœªè§£å†³çš„å‘Šè­¦

  # è·¯ç”±è§„åˆ™
  routes:
    # Critical å‘Šè­¦è·¯ç”±
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 5s
      repeat_interval: 1h
      continue: true  # ç»§ç»­åŒ¹é…å…¶ä»–è·¯ç”±

    # Critical å‘Šè­¦åŒæ—¶å‘é€åˆ° Slack
    - match:
        severity: critical
      receiver: 'slack-critical'
      group_wait: 5s

    # Warning å‘Šè­¦è·¯ç”±
    - match:
        severity: warning
      receiver: 'warning-alerts'
      repeat_interval: 4h

    # Info å‘Šè­¦è·¯ç”±
    - match:
        severity: info
      receiver: 'info-alerts'
      repeat_interval: 24h

    # æŒ‰ç»„ä»¶è·¯ç”±
    - match:
        component: database
      receiver: 'database-team'

    - match:
        component: sandbox
      receiver: 'devops-team'

# æŠ‘åˆ¶è§„åˆ™ (Inhibition Rules)
inhibit_rules:
  # å¦‚æœæœåŠ¡å®Œå…¨ä¸å¯ç”¨,æŠ‘åˆ¶å…¶ä»–æ‰€æœ‰å‘Šè­¦
  - source_match:
      alertname: 'ServiceDown'
    target_match_re:
      alertname: '.*'
    equal: ['instance', 'job']

  # å¦‚æœæœ‰ Critical å‘Šè­¦,æŠ‘åˆ¶åŒç»„ä»¶çš„ Warning å‘Šè­¦
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['component']

  # å¦‚æœé”™è¯¯ç‡é«˜,æŠ‘åˆ¶å»¶è¿Ÿå‘Šè­¦
  - source_match:
      alertname: 'HighErrorRate'
    target_match:
      alertname: 'HighLatency'
    equal: ['instance']

# æ¥æ”¶å™¨é…ç½®
receivers:
  # é»˜è®¤æ¥æ”¶å™¨ (æ§åˆ¶å°æ—¥å¿—)
  - name: 'default'
    webhook_configs:
      - url: 'http://localhost:5001/webhook'
        send_resolved: true

  # Critical å‘Šè­¦æ¥æ”¶å™¨
  - name: 'critical-alerts'
    # Email é…ç½®ç¤ºä¾‹
    # email_configs:
    #   - to: 'oncall@helloagents.com'
    #     from: 'alertmanager@helloagents.com'
    #     smarthost: 'smtp.gmail.com:587'
    #     auth_username: 'your-email@gmail.com'
    #     auth_identity: 'your-email@gmail.com'
    #     auth_password: 'your-app-password'
    #     headers:
    #       Subject: 'ğŸš¨ [CRITICAL] {{ .GroupLabels.alertname }}'

    # PagerDuty é…ç½®ç¤ºä¾‹
    # pagerduty_configs:
    #   - service_key: 'YOUR_PAGERDUTY_SERVICE_KEY'
    #     description: '{{ .GroupLabels.alertname }}: {{ .CommonAnnotations.summary }}'

    # Webhook é…ç½®
    webhook_configs:
      - url: 'http://localhost:5001/webhook/critical'
        send_resolved: true

  # Slack Critical å‘Šè­¦
  - name: 'slack-critical'
    # slack_configs:
    #   - channel: '#incidents'
    #     color: 'danger'
    #     title: 'ğŸš¨ CRITICAL: {{ .GroupLabels.alertname }}'
    #     text: |
    #       {{ range .Alerts }}
    #       *Summary:* {{ .Annotations.summary }}
    #       *Description:* {{ .Annotations.description }}
    #       *Component:* {{ .Labels.component }}
    #       {{ if .Annotations.runbook_url }}*Runbook:* {{ .Annotations.runbook_url }}{{ end }}
    #       {{ end }}
    #     actions:
    #       - type: button
    #         text: 'View in Grafana'
    #         url: 'http://localhost:3000'
    #       - type: button
    #         text: 'Silence'
    #         url: 'http://localhost:9093/#/silences/new'
    webhook_configs:
      - url: 'http://localhost:5001/webhook/slack-critical'

  # Warning å‘Šè­¦æ¥æ”¶å™¨
  - name: 'warning-alerts'
    # slack_configs:
    #   - channel: '#alerts'
    #     color: 'warning'
    #     title: 'âš ï¸ WARNING: {{ .GroupLabels.alertname }}'
    #     text: |
    #       {{ range .Alerts }}
    #       *Summary:* {{ .Annotations.summary }}
    #       *Description:* {{ .Annotations.description }}
    #       {{ end }}
    webhook_configs:
      - url: 'http://localhost:5001/webhook/warning'

  # Info å‘Šè­¦æ¥æ”¶å™¨
  - name: 'info-alerts'
    # slack_configs:
    #   - channel: '#monitoring'
    #     color: 'good'
    #     title: 'â„¹ï¸ INFO: {{ .GroupLabels.alertname }}'
    #     text: '{{ .CommonAnnotations.summary }}'
    webhook_configs:
      - url: 'http://localhost:5001/webhook/info'

  # æ•°æ®åº“å›¢é˜Ÿæ¥æ”¶å™¨
  - name: 'database-team'
    # email_configs:
    #   - to: 'database-team@helloagents.com'
    #     from: 'alertmanager@helloagents.com'
    webhook_configs:
      - url: 'http://localhost:5001/webhook/database-team'

  # DevOps å›¢é˜Ÿæ¥æ”¶å™¨
  - name: 'devops-team'
    # email_configs:
    #   - to: 'devops@helloagents.com'
    #     from: 'alertmanager@helloagents.com'
    webhook_configs:
      - url: 'http://localhost:5001/webhook/devops-team'

# ===================================================================
# é…ç½®è¯´æ˜:
#
# 1. Slack é›†æˆ:
#    - åˆ›å»º Slack Incoming Webhook
#    - å°† webhook URL é…ç½®åˆ° global.slack_api_url
#    - å–æ¶ˆæ³¨é‡Š slack_configs éƒ¨åˆ†
#
# 2. Email é›†æˆ:
#    - é…ç½® SMTP æœåŠ¡å™¨ä¿¡æ¯
#    - å–æ¶ˆæ³¨é‡Š email_configs éƒ¨åˆ†
#    - å¦‚ä½¿ç”¨ Gmail,éœ€è¦ç”Ÿæˆ App Password
#
# 3. PagerDuty é›†æˆ:
#    - åˆ›å»º PagerDuty Service
#    - è·å– Service Integration Key
#    - å–æ¶ˆæ³¨é‡Š pagerduty_configs éƒ¨åˆ†
#
# 4. è‡ªå®šä¹‰ Webhook:
#    - å®ç°æ¥æ”¶å‘Šè­¦çš„ HTTP ç«¯ç‚¹
#    - é…ç½® webhook_configs
# ===================================================================
