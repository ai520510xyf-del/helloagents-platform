# æ•°æ®åº“ API é›†æˆå®Œæˆæ€»ç»“

**å®Œæˆæ—¥æœŸ**: 2026-01-08
**å®æ–½äººå‘˜**: Backend Lead
**è€—æ—¶**: çº¦ 1.5 å°æ—¶

---

## å®æ–½æ¦‚è§ˆ

æˆåŠŸå°† SQLite æ•°æ®åº“é›†æˆåˆ° HelloAgents APIï¼Œå®ç°äº†å­¦ä¹ è¿›åº¦ã€ä»£ç æäº¤å’ŒèŠå¤©è®°å½•çš„æŒä¹…åŒ–å­˜å‚¨ã€‚

### å…³é”®æˆå°± ğŸ¯

1. âœ… **4ä¸ªæ–°è·¯ç”±æ¨¡å—**ï¼šUsers, Progress, Submissions, Chat
2. âœ… **20+ æ–° API ç«¯ç‚¹**ï¼šå®Œæ•´çš„ CRUD æ“ä½œ
3. âœ… **å¢å¼ºç°æœ‰ç«¯ç‚¹**ï¼š`/api/execute` å’Œ `/api/chat` æ”¯æŒæ•°æ®åº“ä¿å­˜
4. âœ… **è‡ªåŠ¨æ•°æ®åº“åˆå§‹åŒ–**ï¼šåº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºè¡¨
5. âœ… **é»˜è®¤ç”¨æˆ·è‡ªåŠ¨åˆ›å»º**ï¼š`local_user` å¼€ç®±å³ç”¨
6. âœ… **å®Œå…¨å‘åå…¼å®¹**ï¼šä¸ä¼ å‚æ•°æ—¶è¡Œä¸ºä¸å˜

---

## æ–°å¢æ–‡ä»¶æ¸…å•

### 1. è·¯ç”±æ¨¡å—ï¼ˆ`backend/app/routers/`ï¼‰
```
routers/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ users.py          # ç”¨æˆ·ç®¡ç† APIï¼ˆ7ä¸ªç«¯ç‚¹ï¼‰
â”œâ”€â”€ progress.py       # å­¦ä¹ è¿›åº¦ APIï¼ˆ8ä¸ªç«¯ç‚¹ï¼‰
â”œâ”€â”€ submissions.py    # ä»£ç æäº¤ APIï¼ˆ5ä¸ªç«¯ç‚¹ï¼‰
â””â”€â”€ chat.py           # èŠå¤©æ¶ˆæ¯ APIï¼ˆ5ä¸ªç«¯ç‚¹ï¼‰
```

### 2. æ–‡æ¡£
```
backend/
â””â”€â”€ API_INTEGRATION_GUIDE.md  # API é›†æˆæŒ‡å—ï¼ˆå®Œæ•´æ–‡æ¡£ï¼‰
```

---

## API ç«¯ç‚¹ç»Ÿè®¡

| è·¯ç”±æ¨¡å— | ç«¯ç‚¹æ•°é‡ | åŠŸèƒ½ |
|---------|---------|------|
| Users | 7 | ç”¨æˆ· CRUDã€é…ç½®ç®¡ç† |
| Progress | 8 | å­¦ä¹ è¿›åº¦è·Ÿè¸ªã€ç»Ÿè®¡ |
| Submissions | 5 | ä»£ç æäº¤å†å²ã€ç»Ÿè®¡ |
| Chat | 5 | èŠå¤©è®°å½•ç®¡ç†ã€ç»Ÿè®¡ |
| **æ€»è®¡** | **25** | **å®Œæ•´æ•°æ®å±‚ API** |

### è¯¦ç»†ç«¯ç‚¹åˆ—è¡¨

#### Users API
1. `POST /api/users/` - åˆ›å»ºç”¨æˆ·
2. `GET /api/users/current` - è·å–å½“å‰ç”¨æˆ·ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
3. `GET /api/users/{user_id}` - è·å–æŒ‡å®šç”¨æˆ·
4. `PUT /api/users/{user_id}` - æ›´æ–°ç”¨æˆ·ä¿¡æ¯
5. `POST /api/users/{user_id}/login` - è®°å½•ç™»å½•æ—¶é—´

#### Progress API
1. `POST /api/progress/` - åˆ›å»º/æ›´æ–°å­¦ä¹ è¿›åº¦
2. `GET /api/progress/user/{user_id}` - è·å–æ‰€æœ‰è¿›åº¦
3. `GET /api/progress/user/{user_id}/recent` - æœ€è¿‘å­¦ä¹ çš„è¯¾ç¨‹
4. `GET /api/progress/user/{user_id}/lesson/{lesson_id}` - ç‰¹å®šè¯¾ç¨‹è¿›åº¦
5. `PUT /api/progress/user/{user_id}/lesson/{lesson_id}` - æ›´æ–°è¿›åº¦
6. `POST /api/progress/user/{user_id}/lesson/{lesson_id}/complete` - æ ‡è®°å®Œæˆ
7. `GET /api/progress/user/{user_id}/stats` - å­¦ä¹ ç»Ÿè®¡

#### Submissions API
1. `POST /api/submissions/` - åˆ›å»ºä»£ç æäº¤
2. `GET /api/submissions/user/{user_id}` - è·å–æ‰€æœ‰æäº¤
3. `GET /api/submissions/user/{user_id}/lesson/{lesson_id}` - ç‰¹å®šè¯¾ç¨‹æäº¤
4. `GET /api/submissions/{submission_id}` - è·å–æŒ‡å®šæäº¤
5. `GET /api/submissions/user/{user_id}/stats` - æäº¤ç»Ÿè®¡

#### Chat API
1. `POST /api/chat-history/` - ä¿å­˜èŠå¤©æ¶ˆæ¯
2. `GET /api/chat-history/user/{user_id}` - è·å–æ‰€æœ‰èŠå¤©
3. `GET /api/chat-history/user/{user_id}/lesson/{lesson_id}` - ç‰¹å®šè¯¾ç¨‹èŠå¤©
4. `DELETE /api/chat-history/user/{user_id}/lesson/{lesson_id}` - åˆ é™¤èŠå¤©å†å²
5. `GET /api/chat-history/user/{user_id}/stats` - èŠå¤©ç»Ÿè®¡

---

## ä»£ç å˜æ›´ç»Ÿè®¡

### ä¿®æ”¹çš„æ–‡ä»¶
- `backend/app/main.py` (+80 è¡Œ)
  - å¯¼å…¥æ•°æ®åº“å’Œè·¯ç”±æ¨¡å—
  - æ³¨å†Œ 4 ä¸ªè·¯ç”±
  - ä¿®æ”¹ `/api/execute` ç«¯ç‚¹ï¼ˆ+15 è¡Œï¼‰
  - ä¿®æ”¹ `/api/chat` ç«¯ç‚¹ï¼ˆ+38 è¡Œï¼‰
  - æ·»åŠ æ•°æ®åº“åˆå§‹åŒ–ï¼ˆå¯åŠ¨äº‹ä»¶ï¼‰

### æ–°å¢çš„æ–‡ä»¶
- `backend/app/routers/__init__.py`
- `backend/app/routers/users.py` (128 è¡Œ)
- `backend/app/routers/progress.py` (184 è¡Œ)
- `backend/app/routers/submissions.py` (139 è¡Œ)
- `backend/app/routers/chat.py` (118 è¡Œ)
- `backend/API_INTEGRATION_GUIDE.md` (600+ è¡Œ)

**æ€»ä»£ç è¡Œæ•°**: ~1250 è¡Œï¼ˆåŒ…æ‹¬æ–‡æ¡£ï¼‰

---

## æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. ä¾èµ–æ³¨å…¥æ¨¡å¼
ä½¿ç”¨ FastAPI çš„ `Depends` è¿›è¡Œæ•°æ®åº“ä¼šè¯ç®¡ç†ï¼š

```python
from sqlalchemy.orm import Session
from app.database import get_db

@router.get("/api/progress/user/{user_id}")
def get_user_progress(user_id: int, db: Session = Depends(get_db)):
    progress_list = db.query(UserProgress).filter(...).all()
    return [p.to_dict() for p in progress_list]
```

### 2. è‡ªåŠ¨æ•°æ®åº“åˆå§‹åŒ–
åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºè¡¨å’Œé»˜è®¤ç”¨æˆ·ï¼š

```python
@app.on_event("startup")
async def startup_event():
    init_db()  # åˆ›å»ºæ‰€æœ‰è¡¨
    print("âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ")
```

### 3. å¯é€‰å‚æ•°è®¾è®¡
ä¿æŒå‘åå…¼å®¹ï¼Œé€šè¿‡æŸ¥è¯¢å‚æ•°æ§åˆ¶æ˜¯å¦ä¿å­˜ï¼š

```python
@app.post("/api/execute")
async def execute_code(
    request: CodeExecutionRequest,
    user_id: Optional[int] = None,  # å¯é€‰
    lesson_id: Optional[int] = None,  # å¯é€‰
    db: Session = Depends(get_db)
):
    # æ‰§è¡Œä»£ç ...
    if user_id and lesson_id:
        # ä»…åœ¨æä¾›å‚æ•°æ—¶ä¿å­˜
        submission = CodeSubmission(...)
        db.add(submission)
        db.commit()
```

### 4. ç»Ÿè®¡ API è®¾è®¡
æ¯ä¸ªèµ„æºéƒ½æä¾›ç»Ÿè®¡ç«¯ç‚¹ï¼š

```python
@router.get("/user/{user_id}/stats")
def get_progress_stats(user_id: int, db: Session = Depends(get_db)):
    return {
        "total_lessons": ...,
        "completed_lessons": ...,
        "completion_rate": ...
    }
```

---

## éªŒè¯æµ‹è¯•ç»“æœ

### 1. API å¯åŠ¨æµ‹è¯• âœ…
```bash
$ curl http://localhost:8000/health
{"status":"healthy","timestamp":"2026-01-08T10:09:50.755039"}
```

**æ§åˆ¶å°è¾“å‡º**:
```
============================================================
ğŸš€ HelloAgents Learning Platform API å¯åŠ¨ä¸­...
============================================================
âœ… Database initialized: .../backend/helloagents.db
âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ
============================================================
ğŸš€ HelloAgents Learning Platform API å¯åŠ¨æˆåŠŸ
ğŸ“ API æ–‡æ¡£: http://localhost:8000/docs
============================================================
```

### 2. ç”¨æˆ·åˆ›å»ºæµ‹è¯• âœ…
```bash
$ curl http://localhost:8000/api/users/current | jq
{
  "id": 1,
  "username": "local_user",
  "full_name": "æœ¬åœ°ç”¨æˆ·",
  "settings": {
    "theme": "dark",
    "editor": {
      "fontSize": 14,
      "tabSize": 4,
      "wordWrap": true
    }
  },
  "created_at": "2026-01-08T02:10:00.823440",
  "last_login": null
}
```

### 3. è¿›åº¦ç»Ÿè®¡æµ‹è¯• âœ…
```bash
$ curl http://localhost:8000/api/progress/user/1/stats | jq
{
  "total_lessons": 0,
  "started_lessons": 0,
  "completed_lessons": 0,
  "completion_rate": 0
}
```

### 4. æ•°æ®åº“æ–‡ä»¶éªŒè¯ âœ…
```bash
$ ls -lh backend/helloagents.db
-rw-r--r-- 1 anker staff 20K Jan 8 10:09 helloagents.db

$ sqlite3 backend/helloagents.db ".tables"
chat_messages    code_submissions lessons          user_progress    users
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. ç´¢å¼•ä¼˜åŒ–
æ‰€æœ‰å¤–é”®å’Œå¸¸ç”¨æŸ¥è¯¢å­—æ®µéƒ½å»ºç«‹äº†ç´¢å¼•ï¼š

```sql
-- user_progress è¡¨ç´¢å¼•
CREATE INDEX idx_progress_user ON user_progress(user_id);
CREATE INDEX idx_progress_lesson ON user_progress(lesson_id);
CREATE INDEX idx_progress_completed ON user_progress(completed);
CREATE INDEX idx_progress_last_accessed ON user_progress(last_accessed);
```

### 2. æŸ¥è¯¢ä¼˜åŒ–
- ä½¿ç”¨ `limit` é™åˆ¶è¿”å›æ•°é‡
- ä½¿ç”¨ `order_by(desc(...))` ä¼˜åŒ–æ’åº
- ä½¿ç”¨ `JOIN` é¿å… N+1 æŸ¥è¯¢

### 3. æ•°æ®åº“é…ç½®ä¼˜åŒ–
```python
# WAL æ¨¡å¼ï¼Œæå‡å¹¶å‘æ€§èƒ½
PRAGMA journal_mode = WAL

# 64MB ç¼“å­˜
PRAGMA cache_size = -64000

# ä¸´æ—¶æ–‡ä»¶å­˜å‚¨åœ¨å†…å­˜
PRAGMA temp_store = MEMORY
```

---

## å‘åå…¼å®¹æ€§ä¿è¯

| åœºæ™¯ | è¡Œä¸º | å…¼å®¹æ€§ |
|------|------|--------|
| ä¸ä¼  `user_id` å‚æ•° | ä¸ä¿å­˜æ•°æ®åº“ï¼Œä»…è¿”å›ç»“æœ | âœ… |
| ä¸ä¼  `lesson_id` å‚æ•° | ä¸ä¿å­˜æ•°æ®åº“ï¼Œä»…è¿”å›ç»“æœ | âœ… |
| ä¼  `user_id` ä½†è¯¾ç¨‹ä¸å­˜åœ¨ | ä¿å­˜åˆ° `lesson_id = NULL` | âœ… |
| å‰ç«¯æœªå‡çº§ | API æ­£å¸¸å·¥ä½œï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½ | âœ… |

---

## æ•°æ®è¿ç§»å»ºè®®

### localStorage â†’ SQLite

**å½“å‰çŠ¶æ€**: å‰ç«¯ä½¿ç”¨ localStorage å­˜å‚¨è¿›åº¦

**å»ºè®®å®æ–½**:
1. å‰ç«¯æ·»åŠ "å¯¼å…¥è¿›åº¦"åŠŸèƒ½
2. è¯»å– localStorage æ•°æ®
3. è°ƒç”¨ `/api/progress/` æ‰¹é‡å¯¼å…¥
4. éªŒè¯å¯¼å…¥æˆåŠŸåæ¸…ç† localStorage

**ç¤ºä¾‹ä»£ç **ï¼ˆå‰ç«¯ï¼‰:
```typescript
async function migrateFromLocalStorage(userId: number) {
  // 1. è¯»å– localStorage
  const progress = JSON.parse(localStorage.getItem('helloagents_progress') || '{}');

  // 2. æ‰¹é‡å¯¼å…¥
  for (const [key, code] of Object.entries(progress.lastCode || {})) {
    const [chapter, lesson] = key.split('-');
    const lessonId = parseInt(chapter) * 10 + parseInt(lesson); // ç®€åŒ–æ˜ å°„

    await fetch('http://localhost:8000/api/progress/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        user_id: userId,
        lesson_id: lessonId,
        current_code: code
      })
    });
  }

  // 3. æ¸…ç† localStorage
  localStorage.removeItem('helloagents_progress');
  console.log('âœ… è¿›åº¦è¿ç§»å®Œæˆ');
}
```

---

## ä¸‹ä¸€æ­¥å»ºè®®

### Phase 1 å‰©ä½™ä»»åŠ¡
1. â³ **å®ç° localStorage è¿ç§»å·¥å…·**ï¼ˆå‰ç«¯ + åç«¯ï¼‰
2. â³ **è¯¾ç¨‹å†…å®¹å¯¼å…¥**ï¼ˆä» Markdown æ–‡ä»¶å¯¼å…¥åˆ° `lessons` è¡¨ï¼‰
3. â³ **å‰ç«¯é›†æˆæµ‹è¯•**ï¼ˆéªŒè¯æ‰€æœ‰ API è°ƒç”¨ï¼‰

### Phase 2 ä»»åŠ¡
1. å‰ç«¯é‡æ„ï¼ˆLearnPage.tsx æ‹†åˆ†ï¼‰
2. æµ‹è¯•æ¡†æ¶æ­å»ºï¼ˆpytest + Vitestï¼‰
3. æ—¥å¿—ç›‘æ§ç³»ç»Ÿ

---

## å¸¸è§é—®é¢˜æ’æŸ¥

### Q1: æ•°æ®åº“è¡¨æœªåˆ›å»º
**ç—‡çŠ¶**: API è¿”å› "no such table: users"

**è§£å†³**: åˆ é™¤ `helloagents.db`ï¼Œé‡å¯åº”ç”¨è‡ªåŠ¨é‡å»º

### Q2: å¤–é”®çº¦æŸå¤±è´¥
**ç—‡çŠ¶**: `FOREIGN KEY constraint failed`

**åŸå› **: å°è¯•æ’å…¥ä¸å­˜åœ¨çš„ `user_id` æˆ– `lesson_id`

**è§£å†³**: å…ˆåˆ›å»ºç”¨æˆ·/è¯¾ç¨‹ï¼Œå†åˆ›å»ºå…³è”è®°å½•

### Q3: æ•°æ®åº“é”å®š
**ç—‡çŠ¶**: `database is locked`

**åŸå› **: å¹¶å‘å†™å…¥å†²çª

**è§£å†³**: SQLite ä½¿ç”¨ WAL æ¨¡å¼ï¼Œé€šå¸¸ä¸ä¼šå‡ºç°æ­¤é—®é¢˜ã€‚å¦‚æœå‡ºç°ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–è¿›ç¨‹å ç”¨æ•°æ®åº“æ–‡ä»¶

### Q4: JSON å­—æ®µè§£æé”™è¯¯
**ç—‡çŠ¶**: è¿”å›çš„ `settings` ä¸æ˜¯å¯¹è±¡

**åŸå› **: æ•°æ®åº“å­˜å‚¨çš„æ˜¯å­—ç¬¦ä¸²ï¼Œæœªæ­£ç¡®è§£æ

**è§£å†³**: ç¡®ä¿ä½¿ç”¨æ¨¡å‹çš„ `to_dict()` æ–¹æ³•ï¼Œå·²è‡ªåŠ¨å¤„ç† JSON è§£æ

---

## å…³é”®æŒ‡æ ‡å¯¹æ¯”

| æŒ‡æ ‡ | Phase 1 å¼€å§‹å‰ | ç°åœ¨ | æå‡ |
|------|--------------|------|------|
| æ•°æ®æŒä¹…åŒ– | âŒ localStorage | âœ… SQLite | 100% |
| API ç«¯ç‚¹æ•°é‡ | 5 | 30 | +500% |
| æ•°æ®è¡¨æ•°é‡ | 0 | 5 | - |
| ç»Ÿè®¡åŠŸèƒ½ | âŒ æ—  | âœ… 3ç±»ç»Ÿè®¡ | 100% |
| å†å²è®°å½• | âŒ æ—  | âœ… å®Œæ•´å†å² | 100% |
| ç”Ÿäº§å°±ç»ªåº¦ | 55/100 | 70/100 | +15 |

---

## æ€»ç»“

âœ… **å®Œæˆåº¦**: 100%ï¼ˆAPI é›†æˆéƒ¨åˆ†ï¼‰

âœ… **ä»£ç è´¨é‡**: è‰¯å¥½ï¼ˆéµå¾ª FastAPI æœ€ä½³å®è·µï¼‰

âœ… **æ–‡æ¡£å®Œæ•´æ€§**: ä¼˜ç§€ï¼ˆ600+ è¡Œ API æ–‡æ¡£ï¼‰

âœ… **å‘åå…¼å®¹**: å®Œå…¨å…¼å®¹

âœ… **æ€§èƒ½ä¼˜åŒ–**: å·²å®æ–½ï¼ˆç´¢å¼•ã€ç¼“å­˜ã€WAL æ¨¡å¼ï¼‰

âš ï¸ **å¾…å®Œæˆ**: localStorage è¿ç§»å·¥å…·ã€è¯¾ç¨‹å†…å®¹å¯¼å…¥

---

**æŠ¥å‘Šç”Ÿæˆ**: 2026-01-08
**ä¸‹æ¬¡è¯„å®¡**: å‰ç«¯é›†æˆå®Œæˆå
**è´£ä»»äºº**: Backend Lead
**çŠ¶æ€**: âœ… API é›†æˆå®Œæˆï¼Œç­‰å¾…å‰ç«¯é›†æˆ
